<style>
    .comment-system {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
    }

    .comment-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }

    .submit-btn {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
    }

    .submit-btn:hover:not(:disabled) {
        background: #0056b3;
    }

    .submit-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }

    .comments-list {
        margin-top: 30px;
    }

    .comments-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
    }

    .comment-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        transition: box-shadow 0.2s;
    }

    .comment-item:hover {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-size: 14px;
    }

    .comment-author {
        font-weight: 600;
        color: #007bff;
    }

    .comment-time {
        color: #6c757d;
        font-size: 12px;
    }

    .comment-content {
        color: #333;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .loading {
        text-align: center;
        color: #6c757d;
        padding: 20px;
    }

    .error {
        background: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        border: 1px solid #f5c6cb;
    }

    .success {
        background: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        border: 1px solid #c3e6cb;
    }

    .empty-comments {
        text-align: center;
        color: #6c757d;
        padding: 40px;
        font-style: italic;
    }

    .char-counter {
        text-align: right;
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
    }

    .char-counter.warning {
        color: #dc3545;
    }
</style>
<div class="comment-system">
    <div class="comment-form">
        <h3>发表留言</h3>
        <div id="message"></div>

        <form id="commentForm">
            <div class="form-group">
                <label for="author">昵称：</label>
                <input type="text" id="author" name="author" required maxlength="50" placeholder="请输入您的昵称">
            </div>

            <div class="form-group">
                <label for="content">留言内容：</label>
                <textarea id="content" name="content" required maxlength="500" placeholder="请输入留言内容..."></textarea>
                <div class="char-counter" id="charCounter">0/500</div>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">发表留言</button>
        </form>
    </div>

    <div class="comments-list">
        <div class="comments-title">
            留言列表 <span id="commentCount">(0)</span>
        </div>
        <div id="commentsContainer">
            <div class="loading">加载中...</div>
        </div>
    </div>
</div>

<script>
    // 配置
    const API_BASE = 'https://bolg-lyb.zhou3534.workers.dev/'; // 替换为你的 Worker 域名

    // 获取当前文章ID
    function getArticleId() {
        const urlParams = new URLSearchParams(window.location.search);
        const file = urlParams.get('file');
        return file || 'default';
    }

    // 显示消息
    function showMessage(message, type = 'error') {
        const messageDiv = document.getElementById('message');
        messageDiv.innerHTML = `<div class="${type}">${message}</div>`;
        setTimeout(() => {
            messageDiv.innerHTML = '';
        }, 5000);
    }

    // 格式化时间
    function formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString('zh-CN');
    }

    // 加载留言
    async function loadComments() {
        try {
            const articleId = getArticleId();
            const response = await fetch(`${API_BASE}/api/comments?article=${encodeURIComponent(articleId)}`);
            const data = await response.json();

            if (data.success) {
                displayComments(data.comments);
                document.getElementById('commentCount').textContent = `(${data.total})`;
            } else {
                throw new Error(data.error || '加载留言失败');
            }
        } catch (error) {
            console.error('Load comments error:', error);
            document.getElementById('commentsContainer').innerHTML =
                '<div class="error">加载留言失败，请刷新重试</div>';
        }
    }

    // 显示留言列表
    function displayComments(comments) {
        const container = document.getElementById('commentsContainer');

        if (!comments || comments.length === 0) {
            container.innerHTML = '<div class="empty-comments">暂无留言，快来发表第一条留言吧！</div>';
            return;
        }

        const html = comments.map(comment => `
                <div class="comment-item">
                    <div class="comment-header">
                        <span class="comment-author">${escapeHtml(comment.author)}</span>
                        <span class="comment-time">${formatTime(comment.timestamp)}</span>
                    </div>
                    <div class="comment-content">${escapeHtml(comment.content)}</div>
                </div>
            `).join('');

        container.innerHTML = html;
    }

    // HTML转义
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // 提交留言
    async function submitComment(e) {
        e.preventDefault();

        const submitBtn = document.getElementById('submitBtn');
        const author = document.getElementById('author').value.trim();
        const content = document.getElementById('content').value.trim();

        if (!author || !content) {
            showMessage('请填写完整信息');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = '提交中...';

        try {
            const response = await fetch(`${API_BASE}/api/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    article: getArticleId(),
                    author: author,
                    content: content
                })
            });

            const data = await response.json();

            if (data.success) {
                showMessage('留言发表成功！', 'success');
                document.getElementById('commentForm').reset();
                updateCharCounter();
                loadComments(); // 重新加载留言列表
            } else {
                throw new Error(data.error || '发表失败');
            }
        } catch (error) {
            console.error('Submit error:', error);
            showMessage(error.message || '发表失败，请重试');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = '发表留言';
        }
    }

    // 更新字符计数器
    function updateCharCounter() {
        const content = document.getElementById('content');
        const counter = document.getElementById('charCounter');
        const length = content.value.length;

        counter.textContent = `${length}/500`;
        counter.className = length > 450 ? 'char-counter warning' : 'char-counter';
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function () {
        // 绑定事件
        document.getElementById('commentForm').addEventListener('submit', submitComment);
        document.getElementById('content').addEventListener('input', updateCharCounter);

        // 加载留言
        loadComments();
    });
</script>